<html>
<head>
    <link rel="stylesheet" type="text/css" href="test.css">
    <title>Jank REPL</title>
    <script type='text/javascript'>
    //<![CDATA[
    var smackjack = {  };
    (function () {
        var httpFactory = null;
        var httpFactories = [function () {
            return new XMLHttpRequest();
        }, function () {
            return new ActiveXObject("Msxml2.XMLHTTP");
        }, function () {
            return new ActiveXObject("Microsoft.XMLHTTP");
        }];
        function httpNewRequest() {
            if (httpFactory) {
                return httpFactory();
            } else {
                var request = null;
                for (var i = 0, l = httpFactories.length, factory = httpFactories[i]; !(request !== null || i >= l); i += 1, factory = httpFactories[i]) {
                    try {
                        request = factory();
                    } catch (e) {
                    };
                };
                if (request === null) {
                    httpFactory = function () {
                        throw new Error("XMLHttpRequest not supported");
                    };
                    return httpFactory();
                } else {
                    return request;
                };
            };
        };
        function identity(x) {
            return x;
        };
        function responseXml(request) {
            return request.responseXML;
        };
        function responseText(request) {
            return request.responseText;
        };
        function responseXmlText(request) {
            var result = "";
            var n = request.responseXML.firstChild;
            if (n) {
                n = n.firstChild;
                if (n) {
                    result = n.nodeValue;
                };
            };
            return result;
        };
        function responseJson(request) {
            return JSON.parse(request.responseText);
        };



        function fetchUri(uri, callback, method, body, errorHandler, process) {
            if (method === undefined) {
                method = "GET";
            };
            uri = "http://localhost:8080" + uri;
            //uri = 	"http://localhost:8080/repl-api/ECHO/?arg0=%22%2B%201%202%22"
            var request = httpNewRequest();
            if (!request) {
                console.log("Browser couldn\'t make a request object.");
            };
            request.open(method, uri, true);
            request.onreadystatechange = function () {
                if (4 == request.readyState) {
                    if (request.status >= 200 && request.status < 300 || request.status == 304) {
                        if (callback != null) {
                            callback(process(request));
                        };
                    } else {
                        if (errorHandler == null) {
                            console.log("Error while fetching URI " + uri + " " + request.status + " " + request.statusText);
                        } else {
                            errorHandler(request);
                        };
                    };
                };
                return null;
            };
            if (method == "POST") {
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            };

            request.send(body);
            return null;
        };
        function ajaxEncodeArgs(args) {
            var s = "";
            for (var i = 0; i < args.length; i += 1) {
                if (i > 0) {
                    s += "&";
                };
                s += "arg" + i + "=" + encodeURIComponent(JSON.stringify(args[i]));
            };
            return s;
        };
        function ajaxCall(func, args, method, callback, errorHandler, process) {
            if (method === undefined) {
                method = "GET";
            };
            var uri = "/repl-api" + "/" + encodeURIComponent(func) + "/";
            var ajaxArgs = ajaxEncodeArgs(args);
            var body = null;
            if (method == "GET" && args.length > 0) {
                uri += "?" + ajaxArgs;
            };
            if (method == "POST") {
                body = ajaxArgs;
            };

            return fetchUri(uri, callback, method, body, errorHandler, process);
        };
        function echo(data, callback, errorHandler) {
            return ajaxCall("ECHO", [data], "GET", callback, errorHandler, responseText);
        };
        smackjack.echo = echo;

        function reset(data, callback, errorHandler) {
            return ajaxCall("RESET", [data], "GET", callback, errorHandler, responseText);
        };
        smackjack.reset = reset;

        return null;
    })();
    //]]>
    </script>

    <!-- moje -->
    <script src="https://code.jquery.com/jquery-2.2.2.min.js" integrity="sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="test.js"></script>

    <script>
        var tabla;

        function callback(response) {
            console.log(response);
            return tabla.nactajString(response);
        };
        function onClick() {
            return smackjack.echo(document.getElementById("data").value, callback);
        };

        function posaljiPotez(kameni, smer) {
            var sel = tabla.selektirani;
            var string = '';
            for (var i = 0; i < sel.length; i++) {
                string += '(' + sel[i].koordinata.x + ' ' + sel[i].koordinata.y + ' ' + sel[i].koordinata.z + ') ';
            }
            string = "(" + string + ") ";
            string = string + smer + ' *tabla*';


            //var string = 'odigrajPotez (caar d) (cadar d) *tabla*';
            //alert(string);
            return smackjack.echo(string, callback);
        }
        window.onload = function () {
            tabla = new Tabla(5);
            tabla.nacrtaj();
            smackjack.reset('', callback);
            // Event listeneri za smerove
            document.getElementById('smer1').addEventListener('click', function () { posaljiPotez(tabla.selektirani, 1); });
            document.getElementById('smer2').addEventListener('click', function () { posaljiPotez(tabla.selektirani, 2); });
            document.getElementById('smer3').addEventListener('click', function () { posaljiPotez(tabla.selektirani, 3); });
            document.getElementById('smer4').addEventListener('click', function () { posaljiPotez(tabla.selektirani, 4); });
            document.getElementById('smer5').addEventListener('click', function () { posaljiPotez(tabla.selektirani, 5); });
            document.getElementById('smer6').addEventListener('click', function () { posaljiPotez(tabla.selektirani, 6); });
        };
        var Koordinata = (function () {
            function Koordinata(x, y, z) {
                if (x === void 0) { x = 0; }
                if (y === void 0) { y = 0; }
                if (z === void 0) { z = 0; }
                this.x = x;
                this.y = y;
                this.z = z;
            }
            return Koordinata;
        })();
        var Kamen = (function () {
            function Kamen(tabla, koordinata, boja) {
                if (koordinata === void 0) { koordinata = new Koordinata(); }
                if (boja === void 0) { boja = '-'; }
                this.tabla = tabla;
                this.koordinata = koordinata;
                this.boja = boja;
            }
            Kamen.prototype.stampaj = function () {
                var _this = this;
                var kamen = document.createElement('div');
                // koji je znak na kamenu
                kamen.classList.add('polje');
                kamen.classList.add('polje-' + this.boja);
                // odredjivanje pozicije
                var sqrt3 = Math.sqrt(3.0);
                var size = 55;
                var x = this.koordinata.x * size;
                var y = this.koordinata.y * size;
                var z = this.koordinata.z * size;
                var left = x + (z - (size - (size * sqrt3) / 2) * (this.koordinata.z % 2)) / 2;
                var top = z;
                top += 250;
                left += 250;
                kamen.style.top = top.toString() + 'px';
                kamen.style.left = left.toString() + 'px';
                // upis u kamen
                kamen.innerHTML = '<span class="koordinate">' + this.koordinata.x + ', ' + this.koordinata.y + ', ' + this.koordinata.z + '</span>';
                document.getElementById("tabla-id").appendChild(kamen);
                this.div = kamen;
                this.div.onclick = function (e) {
                    _this._onclick();
                };
            };
            Kamen.prototype._onclick = function () {
                this.tabla.toggleKamen(this);
            };
            return Kamen;
        })();
        var Tabla = (function () {
            function Tabla(velicina) {
                this.polja = new Array(3 * velicina * velicina - 3 * velicina + 1); // 3nÂ² - 3n + 1
                for (var i = 0; i < this.polja.length; i++) {
                    this.polja[i] = new Kamen(this);
                }
                var index = 0;
                for (var z = -(velicina - 1); z <= (velicina - 1); z++) {
                    var duzinaReda = 2 * velicina - 1 - Math.abs(z); // duzinaReda + abs(z) = 2*velicina -1
                    var x, y;
                    if (z <= 0) {
                        // gornja polovina, sa polovinom
                        y = velicina - 1;
                        x = 0 - z - y;
                    }
                    else {
                        // donja polovina
                        x = -(velicina - 1);
                        y = 0 - x - z;
                    }
                    for (var i = 0; i < duzinaReda; i++) {
                        this.polja[index].koordinata.x = x + i;
                        this.polja[index].koordinata.y = y - i;
                        this.polja[index].koordinata.z = z;
                        index++;
                    }
                }
                this.selektirani = [];
            }
            Tabla.prototype.nacrtaj = function () {
                this.selektirani = [];
                document.getElementById('selektirani').innerHTML = '';
                document.getElementById('tabla-id').innerHTML = '';
                for (var i = 0; i < this.polja.length; i++) {
                    this.polja[i].stampaj();
                }
            };
            Tabla.prototype.toggleKamen = function (kamen) {
                var index = this.selektirani.indexOf(kamen);
                if (index == -1) {
                    // nema ga
                    this.selektirajKamen(kamen);
                }
                else {
                    // ima ga
                    this.deselektirajKamen(kamen);
                }
                // Apdejtovanje DIV-a
                var string = '';
                for (var i = 0; i < tabla.selektirani.length; i++) {
                    string += '<li>';
                    string += tabla.selektirani[i].koordinata.x + ', ' + tabla.selektirani[i].koordinata.y + ', ' + tabla.selektirani[i].koordinata.z;
                    string += '</li>';
                }
                document.getElementById('selektirani').innerHTML = string;
            };
            Tabla.prototype.selektirajKamen = function (kamen) {
                // var size = this.selektirani.filter(function(value) {return value !== undefined}).length;
                if (this.selektirani.length >= 3) {
                    this.selektirani[0].div.classList.remove('selektiran');
                    this.selektirani.splice(0, 1);
                }
                this.selektirani.push(kamen);
                kamen.div.classList.add('selektiran');
            };
            Tabla.prototype.deselektirajKamen = function (kamen) {
                var index = this.selektirani.indexOf(kamen);
                this.selektirani.splice(index, 1);
                kamen.div.classList.remove('selektiran');
            };
            Tabla.prototype.nactajString = function (s) {
                s = s.replace(/\s/g, ''); // skloni sve beline
                s = s.replace(/\"/g, ''); // skloni navodnike
                for (var i = 0; i < Math.min(tabla.polja.length, s.length); i++) {
                    tabla.polja[i].boja = s[i];
                }
                tabla.nacrtaj();
            };
            return Tabla;
        })();
        //# sourceMappingURL=test.js.map
    </script>

</head>

<body>
<p>
    <input id='data' type='text' />
</p>
<p>
    <button type='button' onclick='javascript:onClick()'>Submit!</button>
</p>

<div id="tabla-id"></div>

<ul id="selektirani"></ul>

<ul id="smer-picker">
    <li id="smer1">1</li>
    <li id="smer2">2</li>
    <li id="smer3">3</li>
    <li id="smer4">4</li>
    <li id="smer5">5</li>
    <li id="smer6">6</li>
</ul>

</body>
</html>